@page "/backup"
@inject IAccountService AccountService
@inject IJSRuntime JS

<h3>Backup & Återställning</h3>
<!-- Export button-->
<button class="btn btn-primary" @onclick="Export">Exportera data (JSON)</button>

<!-- Import window-->
<div class="mt-4">
    <label>Klistra in data (JSON) här för import</label>
    <InputTextArea class="form-control" @bind-Value="json" rows="10" />
    <div class="mt-2">
        
        <!-- Import button-->
        <button class="btn btn-secondary ms-2" @onclick="() => Import(false)">Importera (merga)</button>
    </div>
</div>

<!-- Error/Success text -->
@if (errors?.Count > 0)
{
    <div class="alert alert-danger mt-3">
        <ul>@foreach (var e in errors) { <li>@e</li> }</ul>
    </div>
}
@if (ok) { <div class="alert alert-success mt-3">Import klar!</div> }

@code {
    
    /// <summary>
    ///  JSON data to import/export
    /// </summary>
    private string json = "";
    private List<string> errors = new();
    private bool ok = false;
    
    /// <summary>
    ///  Exports JSON data
    /// </summary>
    private async Task Export()
    {
        var data = await AccountService.ExportJsonAsync();
        await JS.InvokeVoidAsync("navigator.clipboard.writeText", data);
    }
    
    /// <summary>
    ///  Imports JSON data
    /// </summary>
    private async Task Import(bool replace)
    {
        errors.Clear();
        ok = false;

        var result = await AccountService.ImportJsonAsync(json, replace);
        if (result.Count == 0)
            ok = true;
        else
            errors = result;
    }
}